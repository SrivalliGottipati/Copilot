!pip install transformers

from transformers import AutoModelForCausalLM, AutoTokenizer, StoppingCriteria, StoppingCriteriaList
import os

model_name = "Salesforce/codegen-2B-mono"

# Load the model and tokenizer
try:
    print("Loading model and tokenizer...")
    tokenizer = AutoTokenizer.from_pretrained(model_name, use_auth_token=HF_API_TOKEN)
    model = AutoModelForCausalLM.from_pretrained(model_name, use_auth_token=HF_API_TOKEN)
    model = model.eval()  # Set the model to evaluation mode
    print("Model and tokenizer loaded successfully.")
except Exception as e:
    print(f"Error loading model or tokenizer: {e}")
    tokenizer = None
    model = None

# Define custom stopping criteria
class CodeStoppingCriteria(StoppingCriteria):
    def __init__(self, stop_strings):
        self.stop_strings = stop_strings

    def __call__(self, input_ids, scores, **kwargs):
        # Decode the current tokens and check for stop strings
        generated_text = tokenizer.decode(input_ids[0], skip_special_tokens=True)
        for stop_string in self.stop_strings:
            if stop_string in generated_text:
                return True
        return False

# Function to generate code
def generate_code(prompt, max_length=100, stop_string="\n\n"):
    if not model or not tokenizer:
        raise Exception("Model or tokenizer not loaded.")

    inputs = tokenizer(prompt, return_tensors="pt").to(model.device)

    # Define stopping criteria
    stopping_criteria = StoppingCriteriaList([CodeStoppingCriteria([stop_string])])

    outputs = model.generate(
        **inputs,
        max_length=len(inputs["input_ids"][0]) + max_length,
        stopping_criteria=stopping_criteria,
        num_return_sequences=1,
        do_sample=True,
        temperature=0.5,  # Lower for more deterministic outputs
        top_k=40,         # Consider only the top 40 options
        top_p=0.9,        # Nucleus sampling
        pad_token_id=tokenizer.eos_token_id,
    )
    generated_code = tokenizer.decode(outputs[0], skip_special_tokens=True)
    return generated_code

# Example prompt for testing
test_prompt = """
def add_numbers(a, b):
    \"\"\"This function adds two numbers and returns the result.\"\"\"
"""

try:
    print("Generating code...")
    result = generate_code(test_prompt)
    print("Generated Code:")
    print(result)
except Exception as e:
    print(f"Error: {e}")
